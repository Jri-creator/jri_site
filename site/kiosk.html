<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Jri Music Player - Kiosk Mode</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: Arial, -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif;
        }
        body {
            background: linear-gradient(135deg, #1a1a1a 0%, #2d2d2d 50%, #1a1a1a 100%);
            color: white;
            overflow: hidden;
            height: 100vh;
            touch-action: manipulation;
            user-select: none;
        }
        .kiosk-container {
            display: grid;
            grid-template-columns: 1fr 400px;
            height: 100vh;
            gap: 20px;
            padding: 20px;
        }
        .artwork-section {
            display: grid;
            place-items: center;
            position: relative;
        }
        .artwork-display {
            width: 98%;
            max-width: 800px;
            aspect-ratio: 1;
            border-radius: 20px;
            overflow: hidden;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.6);
            transition: all 0.8s cubic-bezier(0.25, 0.46, 0.45, 0.94);
            cursor: pointer;
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .artwork-display:hover {
            transform: scale(1.02);
            box-shadow: 0 30px 80px rgba(0, 0, 0, 0.8);
        }
        .artwork-display img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            transition: all 0.8s ease;
        }
        .artwork-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, rgba(0,0,0,0.1) 0%, rgba(0,0,0,0.7) 100%);
            display: grid;
            place-items: center;
            opacity: 0;
            transition: opacity 0.5s ease;
        }
        .artwork-display:hover .artwork-overlay {
            opacity: 1;
        }
        .tap-message {
            background: rgba(255, 255, 255, 0.95);
            color: #333;
            padding: 20px 30px;
            border-radius: 15px;
            font-size: 18px;
            font-weight: bold;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            transform: translateY(20px);
            transition: transform 0.5s ease;
        }
        .artwork-display:hover .tap-message {
            transform: translateY(0);
        }
        .info-section {
            background: rgba(45, 45, 45, 0.8);
            border-radius: 20px;
            padding: 30px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            display: grid;
            grid-template-rows: auto 1fr auto;
            overflow: hidden;
        }
        .current-track {
            margin-bottom: 30px;
            text-align: center;
        }
        .track-title {
            font-size: 24px;
            font-weight: bold;
            margin-bottom: 8px;
            opacity: 0;
            transform: translateY(20px);
            animation: slideInFade 1s ease forwards;
        }
        .track-artist {
            font-size: 18px;
            color: #ccc;
            margin-bottom: 15px;
            opacity: 0;
            transform: translateY(20px);
            animation: slideInFade 1s ease 0.2s forwards;
        }
        .progress-container {
            height: 6px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 3px;
            margin: 15px 0;
            overflow: hidden;
        }
        .progress-bar {
            height: 100%;
            background: linear-gradient(90deg, #79DAE8, #B3E5FC);
            border-radius: 3px;
            width: 0%;
            transition: width 0.3s ease;
        }
        .queue-section {
            overflow-y: auto;
            margin: 20px 0;
        }
        .queue-title {
            font-size: 20px;
            font-weight: bold;
            margin-bottom: 15px;
            color: #79DAE8;
        }
        .queue-item {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
            padding: 12px;
            margin-bottom: 8px;
            border-left: 3px solid #79DAE8;
            transition: all 0.3s ease;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: relative;
        }
        .queue-item:hover {
            background: rgba(255, 255, 255, 0.1);
            transform: translateX(5px);
        }
        .queue-item:hover .delete-btn {
            display: block;
        }
        .queue-item.playing {
            background: rgba(121, 218, 232, 0.2);
            border-left-color: #B3E5FC;
        }
        .queue-item-content {
            flex: 1;
        }
        .queue-item-title {
            font-size: 14px;
            font-weight: bold;
            margin-bottom: 4px;
        }
        .queue-item-artist {
            font-size: 12px;
            color: #ccc;
        }
        .queue-item-requester {
            font-size: 11px;
            color: #79DAE8;
            font-style: italic;
            margin-top: 4px;
        }
        .delete-btn {
            background: rgba(255, 82, 82, 0.8);
            border: none;
            color: white;
            border-radius: 50%;
            width: 25px;
            height: 25px;
            cursor: pointer;
            display: none;
            margin-left: 10px;
            font-size: 16px;
            line-height: 1;
            transition: all 0.3s ease;
        }
        .delete-btn:hover {
            background: rgba(255, 82, 82, 1);
            transform: scale(1.1);
        }
        .controls {
            display: grid;
            grid-template-columns: 1fr 1fr;
            grid-template-rows: 1fr 1fr;
            gap: 10px;
            margin-top: 20px;
        }
        .control-btn {
            background: rgba(255, 255, 255, 0.1);
            border: 2px solid rgba(255, 255, 255, 0.2);
            color: white;
            padding: 15px;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 14px;
            font-weight: bold;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        .control-btn:hover {
            background: rgba(255, 255, 255, 0.2);
            border-color: rgba(255, 255, 255, 0.4);
            transform: translateY(-2px);
        }
        .control-btn.primary {
            background: #79DAE8;
            border-color: #79DAE8;
        }
        .control-btn.primary:hover {
            background: #B3E5FC;
            border-color: #B3E5FC;
        }
        .control-btn.admin {
            background: rgba(121, 218, 232, 0.8);
            border-color: rgba(121, 218, 232, 0.8);
        }
        .control-btn.admin:hover {
            background: rgba(121, 218, 232, 1);
        }
        .control-btn.logout {
            background: rgba(255, 82, 82, 0.8);
            border-color: rgba(255, 82, 82, 0.8);
        }
        .control-btn.logout:hover {
            background: rgba(255, 82, 82, 1);
        }
        .control-btn.restrict {
            background: rgba(255, 165, 0, 0.8);
            border-color: rgba(255, 165, 0, 0.8);
            display: none;
            font-size: 12px;
            padding: 12px 8px;
        }
        .control-btn.restrict:hover {
            background: rgba(255, 165, 0, 1);
        }
        .control-btn.restrict.show {
            display: block;
        }
        /* Modal Styles */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.9);
            display: grid;
            place-items: center;
            opacity: 0;
            visibility: hidden;
            transition: all 0.4s ease;
            z-index: 1000;
        }
        .modal-overlay.show {
            opacity: 1;
            visibility: visible;
        }
        .modal {
            background: linear-gradient(135deg, #2d2d2d, #1a1a1a);
            border-radius: 20px;
            padding: 40px;
            max-width: 90vw;
            max-height: 90vh;
            width: 800px;
            border: 2px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 30px 100px rgba(0, 0, 0, 0.8);
            transform: scale(0.8);
            transition: transform 0.4s ease;
            overflow-y: auto;
        }
        .modal-overlay.show .modal {
            transform: scale(1);
        }
        .modal-header {
            display: grid;
            grid-template-columns: 1fr auto;
            align-items: center;
            margin-bottom: 30px;
        }
        .modal-title {
            font-size: 28px;
            font-weight: bold;
        }
        .close-btn {
            background: rgba(255, 255, 255, 0.1);
            border: none;
            color: white;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 20px;
            transition: all 0.3s ease;
        }
        .close-btn:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: rotate(90deg);
        }
        .user-input {
            margin-bottom: 30px;
        }
        .input-label {
            display: block;
            font-size: 16px;
            margin-bottom: 10px;
            color: #79DAE8;
        }
        .text-input {
            width: 100%;
            padding: 15px;
            border: 2px solid rgba(255, 255, 255, 0.2);
            border-radius: 10px;
            background: rgba(255, 255, 255, 0.05);
            color: white;
            font-size: 16px;
            transition: all 0.3s ease;
        }
        .text-input:focus {
            outline: none;
            border-color: #79DAE8;
            background: rgba(255, 255, 255, 0.1);
        }
        .search-input {
            margin-bottom: 20px;
        }
        .song-list {
            max-height: 400px;
            overflow-y: auto;
            margin-bottom: 20px;
        }
        .song-item {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 2px solid transparent;
        }
        .song-item:hover {
            background: rgba(255, 255, 255, 0.1);
            border-color: rgba(121, 218, 232, 0.5);
            transform: translateX(5px);
        }
        .song-item.selected {
            background: rgba(121, 218, 232, 0.2);
            border-color: #79DAE8;
        }
        .song-item-title {
            font-size: 16px;
            font-weight: bold;
            margin-bottom: 5px;
        }
        .song-item-artist {
            font-size: 14px;
            color: #ccc;
        }
        .modal-actions {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }
        .action-btn {
            padding: 15px 25px;
            border: 2px solid rgba(255, 255, 255, 0.2);
            border-radius: 12px;
            background: rgba(255, 255, 255, 0.1);
            color: white;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        .action-btn:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: translateY(-2px);
        }
        .action-btn.primary {
            background: #79DAE8;
            border-color: #79DAE8;
        }
        .action-btn.primary:hover {
            background: #B3E5FC;
            border-color: #B3E5FC;
        }
        .error-message {
            text-align: center;
            padding: 40px;
            background: rgba(244, 67, 54, 0.1);
            border-radius: 20px;
            border: 2px solid rgba(244, 67, 54, 0.3);
            color: #f44336;
            font-size: 18px;
            font-weight: bold;
            line-height: 1.5;
            max-width: 600px;
            margin: auto;
        }
        .error-icon {
            font-size: 48px;
            margin-bottom: 20px;
            display: block;
        }
        @keyframes slideInFade {
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        .empty-queue {
            text-align: center;
            color: #666;
            font-style: italic;
            padding: 20px;
        }
        .queue-count {
            background: #79DAE8;
            color: white;
            border-radius: 50%;
            width: 25px;
            height: 25px;
            display: inline-grid;
            place-items: center;
            font-size: 12px;
            font-weight: bold;
            margin-left: 10px;
        }
        /* Admin PIN Modal */
        .pin-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.9);
            display: none;
            place-items: center;
            z-index: 2000;
        }
        .pin-modal.show {
            display: grid;
        }
        .pin-content {
            background: linear-gradient(135deg, #2d2d2d, #1a1a1a);
            padding: 40px;
            border-radius: 20px;
            text-align: center;
            box-shadow: 0 30px 100px rgba(0, 0, 0, 0.8);
            border: 2px solid rgba(255, 255, 255, 0.1);
            min-width: 300px;
        }
        .pin-content h2 {
            margin-bottom: 20px;
            color: white;
        }
        .pin-content p {
            margin-bottom: 20px;
            color: #ccc;
        }
        .pin-input {
            width: 100%;
            padding: 15px;
            margin: 20px 0;
            border: 2px solid rgba(255, 255, 255, 0.2);
            border-radius: 10px;
            background: rgba(255, 255, 255, 0.05);
            color: white;
            font-size: 18px;
            text-align: center;
            letter-spacing: 2px;
        }
        .pin-input:focus {
            outline: none;
            border-color: #79DAE8;
        }
        .pin-actions {
            display: flex;
            gap: 15px;
            margin-top: 20px;
        }
        .pin-btn {
            flex: 1;
            background: #79DAE8;
            border: none;
            color: white;
            padding: 12px 25px;
            border-radius: 12px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s ease;
        }
        .pin-btn:hover {
            background: #B3E5FC;
        }
        .pin-btn.cancel {
            background: rgba(255, 255, 255, 0.1);
            border: 2px solid rgba(255, 255, 255, 0.2);
        }
        .pin-btn.cancel:hover {
            background: rgba(255, 255, 255, 0.2);
        }
        /* Restrict Modal */
        .restrict-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.9);
            display: none;
            place-items: center;
            z-index: 3000;
        }
        .restrict-modal.show {
            display: grid;
        }
        .restrict-content {
            background: linear-gradient(135deg, #2d2d2d, #1a1a1a);
            padding: 30px;
            border-radius: 20px;
            text-align: center;
            box-shadow: 0 30px 100px rgba(0, 0, 0, 0.8);
            border: 2px solid rgba(255, 255, 255, 0.1);
            max-width: 90vw;
            max-height: 90vh;
            overflow-y: auto;
            width: 600px;
        }
        .restrict-content h3 {
            margin-bottom: 15px;
            color: white;
        }
        .restrict-content p {
            margin-bottom: 20px;
            color: #ccc;
        }
        .restrict-song-list {
            max-height: 400px;
            overflow-y: auto;
            margin: 20px 0;
        }
        .restrict-song-item {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 10px;
            text-align: left;
        }
        .restrict-song-title {
            font-weight: bold;
            margin-bottom: 5px;
        }
        .restrict-song-artist {
            color: #ccc;
            margin-bottom: 10px;
        }
        .restrict-options {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-top: 10px;
        }
        .restrict-option {
            padding: 8px 15px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            font-size: 12px;
            transition: all 0.3s ease;
        }
        .restrict-option:hover {
            transform: scale(1.05);
        }
        .restrict-option.red {
            background: #e53935;
            color: white;
        }
        .restrict-option.green {
            background: #4CAF50;
            color: white;
        }
        .restrict-option.yellow {
            background: #FFC107;
            color: #333;
        }
        .restrict-cancel {
            margin-top: 20px;
            padding: 12px 30px;
            background: rgba(255, 255, 255, 0.1);
            border: 2px solid rgba(255, 255, 255, 0.2);
            border-radius: 12px;
            cursor: pointer;
            color: white;
            font-weight: bold;
            transition: all 0.3s ease;
        }
        .restrict-cancel:hover {
            background: rgba(255, 255, 255, 0.2);
        }
        .restricted-red {
            opacity: 0.6;
            border-left: 3px solid #e53935 !important;
        }
        .restricted-yellow {
            opacity: 0.8;
            border-left: 3px solid #FFC107 !important;
        }
        /* Responsive Design */
        @media (max-width: 1024px) {
            .kiosk-container {
                grid-template-columns: 1fr;
                grid-template-rows: 1fr auto;
            }
            .info-section {
                max-height: 300px;
            }
        }
        @media (max-width: 768px) {
            .modal {
                width: 95vw;
                padding: 20px;
            }
            .modal-actions {
                grid-template-columns: 1fr;
            }
            .controls {
                grid-template-columns: 1fr 1fr;
                gap: 10px;
            }
        }
    </style>
</head>
<body>
    <div class="kiosk-container">
        <div class="artwork-section">
            <div class="artwork-display" id="artwork-display">
                <img id="artwork-image" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCA0MDAgNDAwIiBmaWxsPSJub25lIj48cmVjdCB3aWR0aD0iNDAwIiBoZWlnaHQ9IjQwMCIgZmlsbD0iIzMzMyIvPjx0ZXh0IHg9IjIwMCIgeT0iMjAwIiBkb21pbmFudC1iYXNlbGluZT0ibWlkZGxlIiB0ZXh0LWFuY2hvcj0ibWlkZGxlIiBmaWxsPSIjNjY2IiBmb250LWZhbWlseT0iQXJpYWwsIHNhbnMtc2VyaWYiIGZvbnQtc2l6ZT0iMzYiPk5vIEFydHdvcms8L3RleHQ+PC9zdmc+" alt="Album Artwork">
                <div class="artwork-overlay">
                    <div class="tap-message">Touch to Add Songs to Queue</div>
                </div>
            </div>
        </div>
        <div class="info-section">
            <div class="current-track">
                <div class="track-title" id="current-title">Welcome to Kiosk Mode</div>
                <div class="track-artist" id="current-artist">Touch the artwork to add songs</div>
                <div class="progress-container">
                    <div class="progress-bar" id="progress-bar"></div>
                </div>
            </div>
            <div class="queue-section">
                <div class="queue-title">
                    Song Queue
                    <span class="queue-count" id="queue-count">0</span>
                </div>
                <div id="queue-list">
                    <div class="empty-queue">No songs in queue. Playing random songs...</div>
                </div>
            </div>
            <div class="controls">
                <button class="control-btn" id="skip-btn">Skip Song</button>
                <button class="control-btn primary" id="add-song-btn">Add Songs</button>
                <button class="control-btn admin" id="admin-btn">Admin Mode</button>
                <button class="control-btn restrict" id="restrict-btn">Restrict Songs</button>
            </div>
        </div>
    </div>
    <!-- Song Selection Modal -->
    <div class="modal-overlay" id="song-modal">
        <div class="modal">
            <div class="modal-header">
                <div class="modal-title">Add Songs to Queue</div>
                <button class="close-btn" id="close-modal">&times;</button>
            </div>
            <div class="user-input">
                <label class="input-label" for="user-name">Your First Name (optional)</label>
                <input type="text" class="text-input" id="user-name" placeholder="Enter your name to be mentioned">
            </div>
            <div class="user-input search-input">
                <label class="input-label" for="search-input">Search Songs</label>
                <input type="text" class="text-input" id="search-input" placeholder="Search by title or artist...">
            </div>
            <div class="song-list" id="song-list">
                <!-- Songs will be populated here -->
            </div>
            <div class="modal-actions">
                <button class="action-btn" id="cancel-btn">Cancel</button>
                <button class="action-btn primary" id="add-selected-btn">Add Selected Songs</button>
            </div>
        </div>
    </div>
    <!-- Admin PIN Modal -->
    <div class="pin-modal" id="pin-modal">
        <div class="pin-content">
            <h2 id="pin-modal-title">Set Admin PIN</h2>
            <p id="pin-modal-text">Set a 4-digit PIN for admin access:</p>
            <input type="password" class="pin-input" id="pin-input" placeholder="Enter 4-digit PIN" maxlength="4">
            <div class="pin-actions">
                <button class="pin-btn cancel" id="pin-cancel">Cancel</button>
                <button class="pin-btn" id="pin-submit">Save PIN</button>
            </div>
        </div>
    </div>
    <!-- Restrict Modal -->
    <div class="restrict-modal" id="restrict-modal">
        <div class="restrict-content">
            <h3>Restrict Songs</h3>
            <p>Select how each song should be handled:</p>
            <div class="restrict-song-list" id="restrict-song-list">
                <!-- Restricted songs will be populated here -->
            </div>
            <button class="restrict-cancel" id="restrict-cancel">Close</button>
        </div>
    </div>
    <audio id="audio-player"></audio>
    <script>
        class KioskMusicPlayer {
            constructor() {
                this.audioPlayer = document.getElementById('audio-player');
                this.artworkImage = document.getElementById('artwork-image');
                this.artworkDisplay = document.getElementById('artwork-display');
                this.currentTitle = document.getElementById('current-title');
                this.currentArtist = document.getElementById('current-artist');
                this.progressBar = document.getElementById('progress-bar');
                this.queueList = document.getElementById('queue-list');
                this.queueCount = document.getElementById('queue-count');
                this.skipBtn = document.getElementById('skip-btn');
                this.addSongBtn = document.getElementById('add-song-btn');
                this.adminBtn = document.getElementById('admin-btn');
                this.restrictBtn = document.getElementById('restrict-btn');
                // Modal elements
                this.songModal = document.getElementById('song-modal');
                this.closeModal = document.getElementById('close-modal');
                this.userNameInput = document.getElementById('user-name');
                this.searchInput = document.getElementById('search-input');
                this.songList = document.getElementById('song-list');
                this.cancelBtn = document.getElementById('cancel-btn');
                this.addSelectedBtn = document.getElementById('add-selected-btn');
                // Admin PIN Modal
                this.pinModal = document.getElementById('pin-modal');
                this.pinInput = document.getElementById('pin-input');
                this.pinSubmit = document.getElementById('pin-submit');
                this.pinCancel = document.getElementById('pin-cancel');
                // Restrict Modal
                this.restrictModal = document.getElementById('restrict-modal');
                this.restrictSongList = document.getElementById('restrict-song-list');
                this.restrictCancel = document.getElementById('restrict-cancel');
                // Player state
                this.tracks = [];
                this.queue = [];
                this.currentTrackIndex = -1;
                this.isPlaying = false;
                this.selectedSongs = new Set();
                this.isAdmin = false;
                this.adminPin = this.getStorageItem('adminPin');
                this.init();
            }
            // Safe storage methods
            getStorageItem(key) {
                try {
                    return localStorage.getItem(key);
                } catch (e) {
                    console.warn('LocalStorage not available:', e);
                    return null;
                }
            }
            setStorageItem(key, value) {
                try {
                    localStorage.setItem(key, value);
                } catch (e) {
                    console.warn('LocalStorage not available:', e);
                }
            }
            removeStorageItem(key) {
                try {
                    localStorage.removeItem(key);
                } catch (e) {
                    console.warn('LocalStorage not available:', e);
                }
            }
            async init() {
                this.setupEventListeners();
                await this.loadTrackData();
                // Show PIN modal only if no PIN is set
                if (!this.adminPin) {
                    this.showPinSetupModal();
                } else {
                    this.startPlayback();
                }
            }
            setupEventListeners() {
                // Touch/click handlers
                this.artworkDisplay.addEventListener('click', () => this.openSongModal());
                this.addSongBtn.addEventListener('click', () => this.openSongModal());
                this.skipBtn.addEventListener('click', () => this.skipTrack());
                this.adminBtn.addEventListener('click', () => this.toggleAdminMode());
                this.restrictBtn.addEventListener('click', () => this.openRestrictModal());
                // Modal handlers
                this.closeModal.addEventListener('click', () => this.closeSongModal());
                this.cancelBtn.addEventListener('click', () => this.closeSongModal());
                this.addSelectedBtn.addEventListener('click', () => this.addSelectedSongs());
                // Admin PIN handlers
                this.pinSubmit.addEventListener('click', () => this.handlePinSubmit());
                this.pinCancel.addEventListener('click', () => this.hidePinModal());
                this.pinInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        this.handlePinSubmit();
                    }
                });
                // Restrict modal handlers
                this.restrictCancel.addEventListener('click', () => this.hideRestrictModal());
                // Search handler
                this.searchInput.addEventListener('input', () => this.filterSongs());
                // Audio events
                this.audioPlayer.addEventListener('ended', () => this.handleTrackEnd());
                this.audioPlayer.addEventListener('timeupdate', () => this.updateProgress());
                this.audioPlayer.addEventListener('loadedmetadata', () => this.updateProgress());
                this.audioPlayer.addEventListener('canplay', () => this.handleCanPlay());
                this.audioPlayer.addEventListener('error', () => this.handleAudioError());
                // Close modals on overlay click
                this.songModal.addEventListener('click', (e) => {
                    if (e.target === this.songModal) {
                        this.closeSongModal();
                    }
                });
                this.pinModal.addEventListener('click', (e) => {
                    if (e.target === this.pinModal) {
                        this.hidePinModal();
                    }
                });
                this.restrictModal.addEventListener('click', (e) => {
                    if (e.target === this.restrictModal) {
                        this.hideRestrictModal();
                    }
                });
                // Touch events for better mobile experience
                this.artworkDisplay.addEventListener('touchstart', (e) => {
                    e.preventDefault();
                }, { passive: false });
            }
            showPinSetupModal() {
                this.pinModal.classList.add('show');
                document.getElementById('pin-modal-title').textContent = 'Set Admin PIN';
                document.getElementById('pin-modal-text').textContent = 'Set a 4-digit PIN for admin access:';
                this.pinInput.value = '';
                this.pinInput.placeholder = 'Enter 4-digit PIN';
                this.pinInput.focus();
            }
            showPinAuthModal() {
                this.pinModal.classList.add('show');
                document.getElementById('pin-modal-title').textContent = 'Enter Admin PIN';
                document.getElementById('pin-modal-text').textContent = 'Enter your 4-digit PIN to access admin mode:';
                this.pinInput.value = '';
                this.pinInput.placeholder = 'Enter PIN';
                this.pinInput.focus();
            }
            hidePinModal() {
                this.pinModal.classList.remove('show');
                this.pinInput.value = '';
            }
            handlePinSubmit() {
                const enteredPin = this.pinInput.value.trim();
                if (enteredPin.length !== 4 || isNaN(enteredPin)) {
                    this.showMessage('Please enter a valid 4-digit PIN.', 'error');
                    return;
                }
                if (!this.adminPin) {
                    // Setting new PIN
                    this.adminPin = enteredPin;
                    this.setStorageItem('adminPin', this.adminPin);
                    this.hidePinModal();
                    this.showMessage('Admin PIN set successfully!', 'success');
                    this.startPlayback();
                } else {
                    // Verifying existing PIN
                    if (enteredPin === this.adminPin) {
                        this.isAdmin = true;
                        this.hidePinModal();
                        this.updateAdminUI();
                        this.showMessage('Admin mode activated!', 'success');
                    } else {
                        this.showMessage('Incorrect PIN! Try again.', 'error');
                        this.pinInput.value = '';
                        this.pinInput.focus();
                    }
                }
            }
            toggleAdminMode() {
                if (this.isAdmin) {
                    // Logout
                    this.isAdmin = false;
                    this.updateAdminUI();
                    this.showMessage('Admin mode deactivated.', 'info');
                } else {
                    // Login
                    this.showPinAuthModal();
                }
            }
            updateAdminUI() {
                if (this.isAdmin) {
                    this.adminBtn.textContent = 'Logout';
                    this.adminBtn.classList.add('logout');
                    this.adminBtn.classList.remove('admin');
                    this.restrictBtn.classList.add('show');
                } else {
                    this.adminBtn.textContent = 'Admin Mode';
                    this.adminBtn.classList.add('admin');
                    this.adminBtn.classList.remove('logout');
                    this.restrictBtn.classList.remove('show');
                }
                this.updateQueueDisplay();
            }
            openRestrictModal() {
                if (!this.isAdmin) {
                    this.showMessage('Admin access required!', 'error');
                    return;
                }
                this.populateRestrictModal();
                this.restrictModal.classList.add('show');
            }
            populateRestrictModal() {
                const restrictions = this.getRestrictions();
                this.restrictSongList.innerHTML = this.tracks.map((track) => {
                    const currentRestriction = restrictions[track.filename] || 'green';
                    return `
                        <div class="restrict-song-item">
                            <div class="restrict-song-title">${track.title}</div>
                            <div class="restrict-song-artist">${track.artist}</div>
                            <div class="restrict-options">
                                <button class="restrict-option red ${currentRestriction === 'red' ? 'active' : ''}"
                                        data-filename="${track.filename}" data-level="red">Don't Play</button>
                                <button class="restrict-option yellow ${currentRestriction === 'yellow' ? 'active' : ''}"
                                        data-filename="${track.filename}" data-level="yellow">Play After Queue</button>
                                <button class="restrict-option green ${currentRestriction === 'green' ? 'active' : ''}"
                                        data-filename="${track.filename}" data-level="green">Play Normal</button>
                            </div>
                        </div>
                    `;
                }).join('');
                // Add event listeners to restriction buttons
                this.restrictSongList.querySelectorAll('.restrict-option').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const filename = e.target.dataset.filename;
                        const level = e.target.dataset.level;
                        this.applyRestriction(filename, level);
                        // Update button states
                        const songItem = e.target.closest('.restrict-song-item');
                        songItem.querySelectorAll('.restrict-option').forEach(b => b.classList.remove('active'));
                        e.target.classList.add('active');
                    });
                });
            }
            hideRestrictModal() {
                this.restrictModal.classList.remove('show');
            }
            getRestrictions() {
                try {
                    return JSON.parse(this.getStorageItem('restrictedSongs') || '{}');
                } catch (e) {
                    console.warn('Error parsing restrictions:', e);
                    return {};
                }
            }
            applyRestriction(filename, level) {
                const restrictions = this.getRestrictions();
                restrictions[filename] = level;
                this.setStorageItem('restrictedSongs', JSON.stringify(restrictions));
                const levelText = {
                    'red': 'will not play',
                    'yellow': 'will play after queue',
                    'green': 'will play normally'
                };
                this.showMessage(`Song restriction updated - ${levelText[level]}.`, 'info');
            }
            async loadTrackData() {
                try {
                    // Load file count
                    const countResponse = await fetch('./filecount.txt');
                    if (!countResponse.ok) throw new Error('Could not load file count');
                    const fileCount = parseInt(await countResponse.text());
                    if (fileCount === 0) {
                        throw new Error('No music files found');
                    }
                    // Load file data
                    const dataResponse = await fetch('./filedata.txt');
                    if (!dataResponse.ok) throw new Error('Could not load file data');
                    const fileData = await dataResponse.text();
                    // Parse file data
                    this.parseTrackData(fileData);
                    if (this.tracks.length === 0) {
                        throw new Error('No valid music files found');
                    }
                    this.populateSongList();
                } catch (error) {
                    console.error('Error loading track data:', error);
                    // Use fallback sample tracks for demonstration
                    this.loadFallbackTracks();
                }
            }
            loadFallbackTracks() {
                // Show critical error message in artwork area
                this.showCriticalError();
                // Also set empty tracks array
                this.tracks = [];
                this.populateSongList();
            }
            generatePlaceholderImage(text, color) {
                return `data:image/svg+xml;base64,${btoa(`
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 400 400" fill="none">
                        <rect width="400" height="400" fill="${color}"/>
                        <text x="200" y="200" dominant-baseline="middle" text-anchor="middle"
                              fill="white" font-family="Arial, sans-serif" font-size="24">${text}</text>
                    </svg>
                `)}`;
            }
            parseTrackData(data) {
                const lines = data.trim().split('\n');
                this.tracks = [];
                for (const line of lines) {
                    if (line.startsWith('(') && line.endsWith(')')) {
                        const content = line.slice(1, -1);
                        const parts = content.split('=');
                        if (parts.length >= 3) {
                            const audioUrl = `https://raw.githubusercontent.com/Jri-creator/jri_site/refs/heads/main/${parts[0]}`;
                            this.tracks.push({
                                filename: audioUrl,
                                title: parts[1].replace(/_EQUAL_/g, '='),
                                artist: parts[2].replace(/_EQUAL_/g, '='),
                                image: parts[3] && parts[3] !== 'none' ? parts[3] : this.generatePlaceholderImage(parts[1], '#666')
                            });
                        }
                    }
                }
            }
            populateSongList() {
                if (!this.songList) return;
                const restrictions = this.getRestrictions();
                this.songList.innerHTML = this.tracks.map((track, index) => `
                    <div class="song-item ${restrictions[track.filename] === 'red' ? 'restricted-red' : ''}" data-index="${index}">
                        <div class="song-item-title">${track.title}</div>
                        <div class="song-item-artist">${track.artist}</div>
                    </div>
                `).join('');
                // Add click handlers
                this.songList.querySelectorAll('.song-item').forEach(item => {
                    item.addEventListener('click', () => {
                        const index = parseInt(item.dataset.index);
                        const restrictions = this.getRestrictions();
                        const track = this.tracks[index];
                        if (restrictions[track.filename] !== 'red') {
                            this.toggleSongSelection(index, item);
                        } else {
                            this.showMessage('This song is restricted and cannot be added.', 'warning');
                        }
                    });
                });
            }
            filterSongs() {
                const searchTerm = this.searchInput.value.toLowerCase();
                const songItems = this.songList.querySelectorAll('.song-item');
                songItems.forEach(item => {
                    const title = item.querySelector('.song-item-title').textContent.toLowerCase();
                    const artist = item.querySelector('.song-item-artist').textContent.toLowerCase();
                    const matches = title.includes(searchTerm) || artist.includes(searchTerm);
                    item.style.display = matches ? 'block' : 'none';
                });
            }
            toggleSongSelection(index, element) {
                if (this.selectedSongs.has(index)) {
                    this.selectedSongs.delete(index);
                    element.classList.remove('selected');
                } else {
                    this.selectedSongs.add(index);
                    element.classList.add('selected');
                }
                this.updateAddButtonText();
            }
            updateAddButtonText() {
                const count = this.selectedSongs.size;
                if (count === 0) {
                    this.addSelectedBtn.textContent = 'Add Selected Songs';
                } else {
                    this.addSelectedBtn.textContent = `Add ${count} Song${count === 1 ? '' : 's'}`;
                }
            }
            openSongModal() {
                this.selectedSongs.clear();
                this.userNameInput.value = '';
                this.searchInput.value = '';
                this.populateSongList();
                this.updateAddButtonText();
                this.songModal.classList.add('show');
                document.body.style.overflow = 'hidden';
            }
            closeSongModal() {
                this.songModal.classList.remove('show');
                document.body.style.overflow = 'auto';
                this.selectedSongs.clear();
            }
            addSelectedSongs() {
                if (this.selectedSongs.size === 0) {
                    this.showMessage('Please select at least one song.', 'warning');
                    return;
                }
                const userName = this.userNameInput.value.trim();
                const restrictions = this.getRestrictions();
                let addedCount = 0;
                this.selectedSongs.forEach(trackIndex => {
                    const track = this.tracks[trackIndex];
                    if (restrictions[track.filename] !== 'red') {
                        this.queue.push({
                            ...track,
                            requester: userName || null,
                            id: Date.now() + Math.random() + trackIndex
                        });
                        addedCount++;
                    }
                });
                this.updateQueueDisplay();
                this.closeSongModal();
                this.showMessage(`${addedCount} song${addedCount === 1 ? '' : 's'} added to queue!`, 'success');
                if (!this.isPlaying && this.queue.length > 0) {
                    this.playNextFromQueue();
                }
            }
            updateQueueDisplay() {
                this.queueCount.textContent = this.queue.length;
                if (this.queue.length === 0) {
                    this.queueList.innerHTML = '<div class="empty-queue">No songs in queue. Playing random songs...</div>';
                    return;
                }
                const restrictions = this.getRestrictions();
                this.queueList.innerHTML = this.queue.map((item, index) => {
                    const restricted = restrictions[item.filename];
                    let restrictedClass = '';
                    if (restricted === 'red') restrictedClass = 'restricted-red';
                    if (restricted === 'yellow') restrictedClass = 'restricted-yellow';
                    return `
                        <div class="queue-item ${index === 0 ? 'playing' : ''} ${restrictedClass}" data-id="${item.id}">
                            <div class="queue-item-content">
                                <div class="queue-item-title">${item.title}</div>
                                <div class="queue-item-artist">${item.artist}</div>
                                ${item.requester ? `<div class="queue-item-requester">Requested by ${item.requester}</div>` : ''}
                            </div>
                            ${this.isAdmin ? `<button class="delete-btn" data-id="${item.id}" title="Remove from queue">&times;</button>` : ''}
                        </div>
                    `;
                }).join('');
                // Add delete handlers for admin
                if (this.isAdmin) {
                    this.queueList.querySelectorAll('.delete-btn').forEach(btn => {
                        btn.addEventListener('click', (e) => {
                            e.stopPropagation();
                            const id = e.target.dataset.id;
                            this.deleteQueueItem(id);
                        });
                    });
                }
            }
            deleteQueueItem(id) {
                const initialLength = this.queue.length;
                this.queue = this.queue.filter(item => item.id != id);
                if (this.queue.length < initialLength) {
                    this.updateQueueDisplay();
                    this.showMessage('Song removed from queue.', 'info');
                }
            }
            startPlayback() {
                if (this.tracks.length === 0) {
                    this.showMessage('No tracks available to play.', 'error');
                    return;
                }
                // If queue is empty, play random song
                if (this.queue.length === 0) {
                    this.playRandomTrack();
                } else {
                    this.playNextFromQueue();
                }
            }
            playRandomTrack() {
                const restrictions = this.getRestrictions();
                const availableTracks = this.tracks.filter(track => restrictions[track.filename] !== 'red');
                if (availableTracks.length === 0) {
                    this.showMessage('No playable tracks available.', 'error');
                    return;
                }
                const randomIndex = Math.floor(Math.random() * availableTracks.length);
                const track = availableTracks[randomIndex];
                this.playTrack(track, null);
            }
            playNextFromQueue() {
                if (this.queue.length === 0) {
                    this.playRandomTrack();
                    return;
                }
                const restrictions = this.getRestrictions();
                let nextTrack = null;
                let nextIndex = -1;
                // Find next playable track
                for (let i = 0; i < this.queue.length; i++) {
                    const item = this.queue[i];
                    const restriction = restrictions[item.filename];
                    if (restriction !== 'red') {
                        nextTrack = item;
                        nextIndex = i;
                        break;
                    }
                }
                if (nextTrack) {
                    // Remove from queue and play
                    this.queue.splice(nextIndex, 1);
                    this.updateQueueDisplay();
                    this.playTrack(nextTrack, nextTrack.requester);
                } else {
                    // All songs restricted, play random
                    this.playRandomTrack();
                }
            }
            playTrack(track, requester = null) {
                this.currentTitle.textContent = track.title;
                this.currentArtist.textContent = track.artist + (requester ? ` (requested by ${requester})` : '');
                // Update artwork with smooth transition
                this.artworkImage.style.opacity = '0';
                setTimeout(() => {
                    this.artworkImage.src = track.image || this.generatePlaceholderImage(track.title, '#666');
                    this.artworkImage.style.opacity = '1';
                }, 300);
                // Load and play audio
                this.audioPlayer.src = track.filename;
                this.audioPlayer.load();
                // Attempt to play
                const playPromise = this.audioPlayer.play();
                if (playPromise !== undefined) {
                    playPromise.then(() => {
                        this.isPlaying = true;
                        console.log('Now playing:', track.title);
                    }).catch(error => {
                        console.error('Playback failed:', error);
                        this.showMessage('Playback failed. Skipping to next track.', 'warning');
                        setTimeout(() => this.handleTrackEnd(), 2000);
                    });
                }
                this.updateDocumentTitle(track, requester);
            }
            skipTrack() {
                this.audioPlayer.pause();
                this.audioPlayer.currentTime = 0;
                this.isPlaying = false;
                this.showMessage('Track skipped.', 'info');
                this.handleTrackEnd();
            }
            handleTrackEnd() {
                this.isPlaying = false;
                // Play next song after brief pause
                setTimeout(() => {
                    if (this.queue.length > 0) {
                        this.playNextFromQueue();
                    } else {
                        this.playRandomTrack();
                    }
                }, 1000);
            }
            handleCanPlay() {
                // Auto-start playback if not already playing
                if (!this.isPlaying) {
                    const playPromise = this.audioPlayer.play();
                    if (playPromise !== undefined) {
                        playPromise.then(() => {
                            this.isPlaying = true;
                        }).catch(error => {
                            console.log('Auto-play prevented by browser:', error);
                            this.showMessage('Click anywhere to start playback.', 'info');
                        });
                    }
                }
            }
            handleAudioError() {
                console.error('Audio error occurred');
                this.showMessage('Audio playback error. Trying next track...', 'error');
                setTimeout(() => this.handleTrackEnd(), 1000);
            }
            updateProgress() {
                if (this.audioPlayer.duration && this.audioPlayer.currentTime) {
                    const progress = (this.audioPlayer.currentTime / this.audioPlayer.duration) * 100;
                    this.progressBar.style.width = `${Math.max(0, Math.min(100, progress))}%`;
                }
            }
            updateDocumentTitle(track, requester) {
                let title = ` ${track.title} - ${track.artist}`;
                if (requester) {
                    title += ` (requested by ${requester})`;
                }
                title += ' | Kiosk Mode';
                document.title = title;
            }
            showMessage(message, type = 'info') {
                // Create temporary message element
                const messageEl = document.createElement('div');
                messageEl.textContent = message;
                messageEl.style.cssText = `
                    position: fixed;
                    top: 20px;
                    left: 50%;
                    transform: translateX(-50%);
                    background: ${type === 'error' ? '#f44336' : type === 'success' ? '#4caf50' : type === 'warning' ? '#ff9800' : '#2196f3'};
                    color: white;
                    padding: 15px 25px;
                    border-radius: 10px;
                    z-index: 10000;
                    font-weight: bold;
                    box-shadow: 0 5px 15px rgba(0,0,0,0.3);
                    transition: all 0.3s ease;
                `;
                document.body.appendChild(messageEl);
                // Fade out and remove
                setTimeout(() => {
                    messageEl.style.opacity = '0';
                    messageEl.style.transform = 'translateX(-50%) translateY(-20px)';
                    setTimeout(() => {
                        if (messageEl.parentNode) {
                            messageEl.parentNode.removeChild(messageEl);
                        }
                    }, 300);
                }, 3000);
            }
        }
        // Initialize when DOM is loaded
        document.addEventListener('DOMContentLoaded', () => {
            const player = new KioskMusicPlayer();
            // Enable click-to-play for browsers that block autoplay
            document.addEventListener('click', function enableAudio() {
                if (player.audioPlayer && player.audioPlayer.paused && !player.isPlaying) {
                    player.audioPlayer.play().catch(() => {});
                }
            }, { once: true });
        });
        // Prevent context menu on touch devices
        document.addEventListener('contextmenu', (e) => {
            e.preventDefault();
        });
        // Handle fullscreen for kiosk mode
        document.addEventListener('keydown', (e) => {
            if (e.key === 'F11') {
                e.preventDefault();
                if (!document.fullscreenElement) {
                    document.documentElement.requestFullscreen().catch(() => {});
                } else {
                    document.exitFullscreen().catch(() => {});
                }
            }
        });
        // Auto-hide cursor after inactivity (kiosk behavior)
        let cursorTimeout;
        function resetCursorTimer() {
            document.body.style.cursor = 'default';
            clearTimeout(cursorTimeout);
            cursorTimeout = setTimeout(() => {
                document.body.style.cursor = 'none';
            }, 5000);
        }
        document.addEventListener('mousemove', resetCursorTimer);
        document.addEventListener('touchstart', resetCursorTimer);
        resetCursorTimer();
    </script>
</body>
</html>
